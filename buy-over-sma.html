<html>
<body style="padding: 100px;">
	<head>
		<link rel="stylesheet" href="styles.css">
		<script src="https://code.highcharts.com/stock/highstock.js"></script>
		<script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
		<script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
		<script src="https://code.highcharts.com/stock/indicators/indicators.js"></script>
		<script src="utilities.js"></script>
	</head>
<script>
	// W I N D O W  V A R S
	window.fetchList = {};
	// W I N D O W  V A R S  E N D

	const popupToggle = () => popup.classList.toggle('hide');

	const simulate = (fetchData) => {
		var smaLine = new MovAvg(parseInt(userInput_smaLength.value));
	    var sellAfter = parseInt(userInput_sellAfter.value); // including the first candle where the guy happened
	    var fees = parseFloat(userInput_fees.value);
	    var smaPercentChangeLowerLimit = userInput_smaPercentChangeLowerLimit.value;
	    var pot = 0;
	    var firstOpenedAbove = [];
	    var lastBuyPrice = null;
	    var lastBuyIndex = null;
	    const settle = (buyPrice, sellPrice) => pc(buyPrice, sellPrice) - fees;
	    const highChartCandleFormatter = (candle, index, buyOrSell) => {
            var returnObj = {
	            x: index,
	            open: parseFloat(candle[1]),
	            high: parseFloat(candle[2]),
	            low: parseFloat(candle[3]),
	            close: parseFloat(candle[4])
            }
            if(buyOrSell === "buy") {
				returnObj["dataLabels"] = {
					enabled: true,
					format: 'B',
					y: 10,
					color: "green"
				}
            } else if(buyOrSell === "sell") {
				returnObj["dataLabels"] = {
					enabled: true,
					format: 'S',
					y: 10,
					color: "red"
				}
            }
            return returnObj;
	    }
	    const fetchDataHighchartFormat =  fetchData.map((candle, index) => {
	        smaLine.addNewPrice(parseFloat(candle[4]));
	        if(index === 0) return highChartCandleFormatter(candle, index);
	        if(lastBuyPrice) {
	            if (index === lastBuyIndex + sellAfter) {
	                pot = settle(lastBuyPrice, parseFloat(candle[4]));
	                lastBuyPrice = null;
	                lastBuyIndex = null;
	                return highChartCandleFormatter(candle, index, "sell");
	            };
	            return highChartCandleFormatter(candle, index);
	        }
	        if(
	        	parseFloat(candle[1]) > smaLine.mostRecentValue() 
	        	&& parseFloat(fetchData[index - 1][1]) <= smaLine.mostRecentValue() 
	        	&& smaLine.mostRecentChange() > smaPercentChangeLowerLimit
	        ){
	            if(sellAfter === 0) {
	                pot = settle(candle[1], candle[4]);
	                lastBuyPrice = null;
	                lastBuyIndex = null;
	                return highChartCandleFormatter(candle, index, "sell");
	            }
	            lastBuyPrice = parseFloat(candle[4]);
	            lastBuyIndex = index;
	            firstOpenedAbove.push(candle);
	            return highChartCandleFormatter(candle, index, "buy");
	        }
	        return highChartCandleFormatter(candle, index);
	    });
	    firstOpenedAbove.map(n => console.log(new Date(n[0])));
	    TEMP_results.innerHTML = pot;
        console.log('• • • • ', fetchDataHighchartFormat)
	    drawChart(fetchDataHighchartFormat); // this needs to add buy and sell points onto the chart with profit/loss and fees
	}

	const drawChart = (fetchDataHighchartFormat) => {
		// FYI https://api.highcharts.com/highstock/series.candlestick.data
		Highcharts.stockChart("theChart", {
			rangeSelector: {
				selected: 1
			},
			title: {
				text: `${userInput_symbol.value}`
			},
			series: [
				{
					type: 'candlestick',
					id: "penis",
					data: fetchDataHighchartFormat
				},
				{
					type: 'sma',
					linkedTo: "penis",
					params: {
						period: parseInt(userInput_smaLength.value)
					},
					color: "orange",
					marker: {
						enabled: false
					}
				}
			],
			chart: {
				backgroundColor: "rgba(0,0,0,1)",
			},
			yAxis: {
				gridLineColor: 'rgba(0,255,0,0.5)',
			},
			plotOptions: {
				candlestick: {
					color: '#ef5351',
					upColor: '#26a79a'
				}
			}
		});
	}

	const run = async () => {
		loadingSpinner.classList.add('spinner');
		const fetchUrl = `https://api.binance.com/api/v3/klines?symbol=${userInput_symbol.value}&interval=${userInput_candleInterval.value}&limit=1000`
		if(!!window.fetchList[fetchUrl]) { // caching
			simulate(window.fetchList[fetchUrl]);
		} else {
			await fetch(fetchUrl).then(raw => raw.json()).then(fetchData => {
		    	simulate(fetchData);
		    	window.fetchList[fetchUrl] = fetchData;
			})
		}
		loadingSpinner.classList.remove('spinner');
		return "FINISHED";
	}

</script>
<div id="popup" class="hide">
	<div id="popupClose" onclick="popupToggle()">X</div>
	<div id="popupContent"></div>
</div>
<nav>
	<a href="index.html">H O M E</a>
	<span> / </span>
	<a href="accelerometer.html">A C C E L E R O M E T E R</a>
	<span> / </span>
	<a href="top-moving-averages.html">S M O O T H  G A I N E R Z</a>
	<span> / </span>
	<a href="cross-alerter.html">C R O S S  A L E R T E R</a>
	<span> / </span>
	<a href="buy-over-sma.html.html">B U Y  O V E R  S M A</a>
</nav>
<h1>Buy Over SMA Line</h1>

<hr />
<strong>To-do</strong>
<ul>
	<li>REALLY needs a limit to the period you're analysing, this isn't something you would run non stop on any chart.</li>
	<li>In relation to the above, a stipulation of recent average candle size would be amazing too, but using a different interval if the user requires.</li>
	<li>seeing the candle dates would be great</li>
	<li>cache with fetch string</li>
	<li>needs neutral or positive MA stipulation</li>
	<li>needs a list of the top recent avg candles</li>
</ul>
<hr />
<h2>Buy Over SMA Line</h2>
<input id="userInput_symbol" type="input" value="BTCUSDT" />
<label>Symbol</label>
<br />
<input id="userInput_candleInterval" type="input" value="5m" />
<label>candle interval (e.g. 1m, 1h, 4h, 1d etc...)</label>
<br />
<input id="userInput_fees" type="input" value="0.2" />
<label>Trading fees</label>
<br />
<input id="userInput_smaLength" type="number" value="50" />
<label>SMA length</label>
<br />
<input id="userInput_smaPercentChangeLowerLimit" type="number" value="0" />
<label>SMA percent change lower limit (0 is a flat line)</label>
<br />
<input id="userInput_sellAfter" type="input" value="2" />
<label>candles to sell after</label>
<br />
<div id="launchSection">
	<button onclick="run()">Launch</button>
</div>

<div id="loadingSpinner"></div>

<div id="TEMP_results"></div>
<div id="theChart"></div>

</body>

</html>
